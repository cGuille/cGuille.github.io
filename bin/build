#!/usr/bin/env bash

set -eu

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
ROOT_DIR="$(realpath "${SCRIPT_DIR}/..")"
source "${ROOT_DIR}/bin/logger.bash"

DOCS_DIR="${ROOT_DIR}/docs/"
DOCS_BACKUP="${ROOT_DIR}/docs.bak/"

BUILD_DIR="$(mktemp -d)"

log "Build start"

log "⋅ Write CNAME file"
echo -n 'notes.cguille.net' > "$BUILD_DIR"/CNAME

log "⋅ Build pages"

find "${ROOT_DIR}/src/pages" \
    -type f -name '*.php' \
    -print0 \
    | xargs -0 --max-args=1 bash "${ROOT_DIR}/bin/build_page.bash" "$BUILD_DIR"

log "⋅ Copy assets"

cp -R "${ROOT_DIR}/src/assets" "$BUILD_DIR"/

log "⋅ Move build to public docs/ directory"

rm -rf "$DOCS_BACKUP"
mv "$DOCS_DIR" "$DOCS_BACKUP"
mv "$BUILD_DIR" "$DOCS_DIR"

log "Build finished"
